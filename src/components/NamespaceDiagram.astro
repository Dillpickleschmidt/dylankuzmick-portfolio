---
---

<div class="cd-ns not-prose" data-active-step="1">
  <svg viewBox="0 0 600 330" xmlns="http://www.w3.org/2000/svg" class="cd-ns-svg">
    <!-- Step 1: Host + Internet -->
    <g data-step="1">
      <!-- Internet arrow (muted by default) -->
      <g class="cd-ns-internet">
        <line x1="300" y1="10" x2="300" y2="38" stroke-width="2" stroke-dasharray="4 3" class="cd-ns-inet-line" />
        <polygon points="294,10 300,0 306,10" />
        <polygon points="294,38 300,48 306,38" />
        <text x="320" y="8" class="cd-ns-label-sm">Internet</text>
      </g>
      <!-- Host box -->
      <rect x="20" y="48" width="560" height="262" rx="10" class="cd-ns-host-rect" />
      <text x="40" y="72" class="cd-ns-label">Your Computer</text>
      <!-- Host network bar -->
      <rect x="60" y="100" width="480" height="24" rx="4" class="cd-ns-netbar" />
      <text x="300" y="116" text-anchor="middle" class="cd-ns-label-sm cd-ns-label-dim">host network stack · 192.168.1.100</text>
    </g>

    <!-- Step 2: Room 1 -->
    <g data-step="2">
      <rect x="60" y="178" width="220" height="112" rx="8" class="cd-ns-room cd-ns-room-green" />
      <text x="170" y="202" text-anchor="middle" class="cd-ns-room-title cd-ns-green">Room 1</text>
      <!-- lo interface -->
      <text x="170" y="222" text-anchor="middle" class="cd-ns-label-sm cd-ns-label-dim">lo (localhost only)</text>
      <!-- no internet indicator -->
      <g class="cd-ns-no-inet">
        <line x1="142" y1="246" x2="198" y2="246" stroke-width="1.5" stroke-dasharray="3 2" />
        <text x="170" y="264" text-anchor="middle" class="cd-ns-label-xs cd-ns-red">no internet</text>
      </g>
    </g>

    <!-- Step 3: Veth pair for Room 1 -->
    <g data-step="3">
      <!-- veth line -->
      <line x1="170" y1="124" x2="170" y2="178" class="cd-ns-veth cd-ns-veth-green cd-ns-veth1" stroke-dasharray="5 3" stroke-width="2" />
      <!-- IP labels -->
      <g class="cd-ns-ip-label">
        <rect x="98" y="128" width="72" height="16" rx="3" class="cd-ns-ip-bg cd-ns-ip-bg-green" />
        <text x="134" y="139" text-anchor="middle" class="cd-ns-label-xs">10.200.1.1</text>
      </g>
      <g class="cd-ns-ip-label">
        <rect x="98" y="155" width="72" height="16" rx="3" class="cd-ns-ip-bg cd-ns-ip-bg-green" />
        <text x="134" y="166" text-anchor="middle" class="cd-ns-label-xs">10.200.1.2</text>
      </g>
    </g>

    <!-- Step 4: NAT enabled -->
    <g data-step="4">
      <!-- NAT label near internet arrow -->
      <g class="cd-ns-nat-label">
        <rect x="339" y="31" width="222" height="32" rx="5" class="cd-ns-nat-mask" />
        <rect x="340" y="32" width="220" height="30" rx="4" class="cd-ns-nat-bg" />
        <text x="450" y="44" text-anchor="middle" class="cd-ns-label-xs cd-ns-nat-title">NAT</text>
        <text x="450" y="56" text-anchor="middle" class="cd-ns-label-xs">10.200.1.2 &rarr; 192.168.1.100:48372</text>
        <text x="450" y="68" text-anchor="middle" class="cd-ns-label-xs cd-ns-nat-line2">10.200.2.2 &rarr; 192.168.1.100:48373</text>
      </g>
    </g>

    <!-- Step 5: Room 2 -->
    <g data-step="5">
      <rect x="320" y="178" width="220" height="112" rx="8" class="cd-ns-room cd-ns-room-orange" />
      <text x="430" y="202" text-anchor="middle" class="cd-ns-room-title cd-ns-orange">Room 2</text>
      <text x="430" y="222" text-anchor="middle" class="cd-ns-label-sm cd-ns-label-dim">lo (localhost only)</text>
      <!-- veth line -->
      <line x1="430" y1="124" x2="430" y2="178" class="cd-ns-veth cd-ns-veth-orange cd-ns-veth2" stroke-dasharray="5 3" stroke-width="2" />
      <!-- IP labels -->
      <g class="cd-ns-ip-label">
        <rect x="358" y="128" width="72" height="16" rx="3" class="cd-ns-ip-bg cd-ns-ip-bg-orange" />
        <text x="394" y="139" text-anchor="middle" class="cd-ns-label-xs">10.200.2.1</text>
      </g>
      <g class="cd-ns-ip-label">
        <rect x="358" y="155" width="72" height="16" rx="3" class="cd-ns-ip-bg cd-ns-ip-bg-orange" />
        <text x="394" y="166" text-anchor="middle" class="cd-ns-label-xs">10.200.2.2</text>
      </g>
      <!-- Port labels in both rooms -->
      <text x="170" y="278" text-anchor="middle" class="cd-ns-port cd-ns-green">:3000</text>
      <text x="430" y="278" text-anchor="middle" class="cd-ns-port cd-ns-orange">:3000</text>
    </g>
  </svg>

  <!-- Step descriptions -->
  <div class="cd-ns-desc">
    <p class="cd-ns-desc-text" data-desc="1">Your computer with its internet connection — the starting point.</p>
    <p class="cd-ns-desc-text" data-desc="2">Create a network namespace — an isolated room with only localhost. No internet yet.</p>
    <p class="cd-ns-desc-text" data-desc="3">Connect a virtual ethernet (veth) cable between the room and the host network.</p>
    <p class="cd-ns-desc-text" data-desc="4">Enable NAT — the host rewrites outgoing packets so Room 1 can reach the internet.</p>
    <p class="cd-ns-desc-text" data-desc="5">Add a second room with its own veth pair and NAT. Both rooms use :3000 — no conflict.</p>
  </div>

  <!-- Stepper -->
  <div class="cd-ns-stepper">
    <button type="button" class="cd-ns-btn" id="cd-ns-back" disabled>&larr; Back</button>
    <div class="cd-ns-dots">
      <button type="button" class="cd-ns-dot cd-ns-dot-active" data-dot="1">1</button>
      <button type="button" class="cd-ns-dot" data-dot="2">2</button>
      <button type="button" class="cd-ns-dot" data-dot="3">3</button>
      <button type="button" class="cd-ns-dot" data-dot="4">4</button>
      <button type="button" class="cd-ns-dot" data-dot="5">5</button>
    </div>
    <button type="button" class="cd-ns-btn" id="cd-ns-next">Next &rarr;</button>
  </div>
</div>

<style>
  .cd-ns {
    --green: #4a9a6a;
    --green-dim: rgba(74, 154, 106, 0.15);
    --orange: #e8603c;
    --orange-dim: rgba(232, 96, 60, 0.15);
    --red: #e04646;
    --chrome: #161616;
    --ease: cubic-bezier(0.16, 1, 0.3, 1);

    margin: 0.75em 0 2.25em;
  }

  .cd-ns-svg {
    display: block;
    width: 100%;
    height: auto;
    padding: 16px 12px 8px;
  }

  /* ---- SVG base styles ---- */
  .cd-ns-host-rect {
    fill: none;
    stroke: var(--color-border);
    stroke-width: 1.5;
  }

  .cd-ns-netbar {
    fill: rgba(255, 255, 255, 0.03);
    stroke: var(--color-border);
    stroke-width: 1;
  }

  .cd-ns-label {
    font-family: var(--font-mono);
    font-size: 11px;
    fill: var(--color-text);
    letter-spacing: 0.03em;
  }

  .cd-ns-label-sm {
    font-family: var(--font-mono);
    font-size: 9px;
    fill: var(--color-text);
    letter-spacing: 0.02em;
  }

  .cd-ns-label-dim {
    fill: var(--color-text-muted);
    opacity: 0.6;
  }

  .cd-ns-label-xs {
    font-family: var(--font-mono);
    font-size: 8.5px;
    fill: var(--color-text);
    letter-spacing: 0.01em;
  }

  /* Internet arrow */
  .cd-ns-internet line,
  .cd-ns-internet polygon {
    stroke: var(--color-text-muted);
    fill: var(--color-text-muted);
    opacity: 0.35;
    transition: opacity 0.4s var(--ease), stroke 0.4s var(--ease), fill 0.4s var(--ease);
  }

  /* When NAT is active (step >= 4), light up internet */
  .cd-ns[data-active-step="4"] .cd-ns-internet line,
  .cd-ns[data-active-step="4"] .cd-ns-internet polygon,
  .cd-ns[data-active-step="5"] .cd-ns-internet line,
  .cd-ns[data-active-step="5"] .cd-ns-internet polygon {
    stroke: var(--green);
    fill: var(--green);
    opacity: 1;
  }

  /* Room boxes */
  .cd-ns-room {
    fill: rgba(255, 255, 255, 0.02);
    stroke-width: 1.5;
  }

  .cd-ns-room-green { stroke: var(--green); }
  .cd-ns-room-orange { stroke: var(--orange); }

  .cd-ns-room-title {
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.04em;
  }

  .cd-ns-green { fill: var(--green); }
  .cd-ns-orange { fill: var(--orange); }
  .cd-ns-red { fill: var(--red); }

  /* Veth lines */
  .cd-ns-veth-green { stroke: var(--green); }
  .cd-ns-veth-orange { stroke: var(--orange); }

  /* IP label backgrounds */
  .cd-ns-ip-bg { fill: rgba(0, 0, 0, 0.3); stroke: none; }
  .cd-ns-ip-bg-green { fill: var(--green-dim); }
  .cd-ns-ip-bg-orange { fill: var(--orange-dim); }

  /* No-internet indicator */
  .cd-ns-no-inet line { stroke: var(--red); opacity: 0.5; }

  /* NAT label */
  .cd-ns-nat-mask {
    fill: var(--color-bg);
    stroke: none;
  }

  .cd-ns-nat-bg {
    fill: var(--green-dim);
    stroke: var(--green);
    stroke-width: 1;
    opacity: 0.8;
  }

  .cd-ns-nat-label text { fill: var(--green); }
  .cd-ns-nat-title { font-weight: 600; letter-spacing: 0.06em; }

  /* Animate box growth for second NAT line */
  .cd-ns-nat-mask, .cd-ns-nat-bg {
    transition: height 0.4s var(--ease);
  }

  .cd-ns[data-active-step="5"] .cd-ns-nat-mask {
    height: 44px;
  }

  .cd-ns[data-active-step="5"] .cd-ns-nat-bg {
    height: 42px;
  }

  .cd-ns-nat-line2 {
    opacity: 0;
    transition: opacity 0.1s;
  }

  .cd-ns[data-active-step="5"] .cd-ns-nat-line2 {
    opacity: 1;
    transition: opacity 0.6s var(--ease);
  }

  /* Port labels */
  .cd-ns-port {
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.02em;
  }

  /* ---- Dash flow animations (driven by JS) ---- */
  .cd-ns-veth1, .cd-ns-veth2, .cd-ns-inet-line {
    transition: stroke-dashoffset 0s;
  }

  /* ---- Step visibility ---- */
  [data-step] {
    opacity: 0;
    transition: opacity 0.4s var(--ease);
  }

  /* Show elements for current and all previous steps */
  .cd-ns[data-active-step="1"] [data-step="1"],
  .cd-ns[data-active-step="2"] [data-step="1"],
  .cd-ns[data-active-step="2"] [data-step="2"],
  .cd-ns[data-active-step="3"] [data-step="1"],
  .cd-ns[data-active-step="3"] [data-step="2"],
  .cd-ns[data-active-step="3"] [data-step="3"],
  .cd-ns[data-active-step="4"] [data-step="1"],
  .cd-ns[data-active-step="4"] [data-step="2"],
  .cd-ns[data-active-step="4"] [data-step="3"],
  .cd-ns[data-active-step="4"] [data-step="4"],
  .cd-ns[data-active-step="5"] [data-step="1"],
  .cd-ns[data-active-step="5"] [data-step="2"],
  .cd-ns[data-active-step="5"] [data-step="3"],
  .cd-ns[data-active-step="5"] [data-step="4"],
  .cd-ns[data-active-step="5"] [data-step="5"] {
    opacity: 1;
  }

  /* Hide "no internet" indicator once veth is connected (step >= 3) */
  .cd-ns[data-active-step="3"] .cd-ns-no-inet,
  .cd-ns[data-active-step="4"] .cd-ns-no-inet,
  .cd-ns[data-active-step="5"] .cd-ns-no-inet {
    opacity: 0 !important;
  }

  /* ---- Description text ---- */
  .cd-ns-desc {
    padding: 0 16px;
    min-height: 2em;
  }

  .cd-ns-desc-text {
    display: none;
    margin: 0;
    font-size: 0.88rem;
    color: var(--color-text-muted);
    text-align: center;
    line-height: 1.4;
    animation: cd-ns-fade 0.3s var(--ease);
  }

  .cd-ns-desc-text.cd-ns-desc-active {
    display: block;
  }

  @keyframes cd-ns-fade {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ---- Stepper ---- */
  .cd-ns-stepper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 12px 16px 16px;
  }

  .cd-ns-dots {
    display: flex;
    gap: 6px;
  }

  .cd-ns-dot {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 1px solid var(--color-border);
    background: transparent;
    color: var(--color-text-muted);
    font-family: var(--font-mono);
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.2s var(--ease);
    display: grid;
    place-items: center;
    padding: 0;
  }

  .cd-ns-dot:hover {
    border-color: var(--color-text-muted);
  }

  .cd-ns-dot-active {
    background: var(--green);
    border-color: var(--green);
    color: #0f0f0f;
    font-weight: 600;
  }

  .cd-ns-dot-active:hover {
    border-color: var(--green);
  }

  .cd-ns-btn {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    letter-spacing: 0.02em;
    background: transparent;
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
    border-radius: 5px;
    padding: 5px 12px;
    cursor: pointer;
    transition: all 0.15s var(--ease);
    white-space: nowrap;
  }

  .cd-ns-btn:hover:not(:disabled) {
    border-color: var(--color-text-muted);
    color: var(--color-text);
  }

  .cd-ns-btn:disabled {
    opacity: 0.3;
    cursor: default;
  }
</style>

<script>
  const root = document.querySelector('.cd-ns') as HTMLElement;
  const backBtn = root.querySelector('#cd-ns-back') as HTMLButtonElement;
  const nextBtn = root.querySelector('#cd-ns-next') as HTMLButtonElement;
  const dots = root.querySelectorAll('.cd-ns-dot') as NodeListOf<HTMLButtonElement>;
  const descs = root.querySelectorAll('.cd-ns-desc-text') as NodeListOf<HTMLElement>;

  const MAX = 5;
  let step = 1;

  function setStep(n: number) {
    step = Math.max(1, Math.min(MAX, n));
    root.dataset.activeStep = String(step);

    backBtn.disabled = step === 1;
    nextBtn.disabled = step === MAX;

    dots.forEach(d => {
      d.classList.toggle('cd-ns-dot-active', Number(d.dataset.dot) === step);
    });

    descs.forEach(d => {
      d.classList.toggle('cd-ns-desc-active', Number(d.dataset.desc) === step);
    });
  }

  backBtn.addEventListener('click', () => setStep(step - 1));
  nextBtn.addEventListener('click', () => setStep(step + 1));
  dots.forEach(d => d.addEventListener('click', () => setStep(Number(d.dataset.dot))));

  // Animated dash flow with random direction changes
  const veth1 = root.querySelector('.cd-ns-veth1') as SVGLineElement | null;
  const veth2 = root.querySelector('.cd-ns-veth2') as SVGLineElement | null;
  const inetLine = root.querySelector('.cd-ns-inet-line') as SVGLineElement | null;

  interface FlowState {
    el: SVGLineElement;
    offset: number;
    dir: number;       // 1 or -1
    cycleLeft: number; // px remaining before maybe flipping
    speed: number;     // px per frame
    minStep: number;   // minimum active step for this line
  }

  const CYCLE = 16; // one full dash+gap = 16px, then maybe flip

  const flows: FlowState[] = [];
  if (veth1) flows.push({ el: veth1, offset: 0, dir: 1, cycleLeft: CYCLE, speed: 0.35, minStep: 3 });
  if (veth2) flows.push({ el: veth2, offset: 0, dir: 1, cycleLeft: CYCLE, speed: 0.35, minStep: 5 });
  if (inetLine) flows.push({ el: inetLine, offset: 0, dir: 1, cycleLeft: CYCLE, speed: 0.45, minStep: 4 });

  const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function tick() {
    for (const f of flows) {
      if (step < f.minStep) continue;
      const delta = f.speed * f.dir;
      f.offset += delta;
      f.cycleLeft -= Math.abs(delta);
      if (f.cycleLeft <= 0) {
        // ~30% chance to flip direction each cycle
        if (Math.random() < 0.3) f.dir *= -1;
        f.cycleLeft = CYCLE;
      }
      f.el.style.strokeDashoffset = `${f.offset}`;
    }
    if (!reducedMotion) requestAnimationFrame(tick);
  }

  if (!reducedMotion) requestAnimationFrame(tick);

  setStep(1);
</script>
